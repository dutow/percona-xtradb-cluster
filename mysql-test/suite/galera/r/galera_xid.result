SET SESSION wsrep_on=OFF;
RESET MASTER;
SET SESSION wsrep_on=ON;
SET SESSION wsrep_on=OFF;
RESET MASTER;
SET SESSION wsrep_on=ON;
#=============================================
#node-1 (fire some basic ddl and dml workload on node-1)
create table t1 (i int, primary key pk(i)) engine=innodb;
insert into t1 values (1), (2), (3), (4);
select * from t1;
i
1
2
3
4
create table t2 as (select * from t1);
insert into t2 values (10), (20), (30);
select * from t2;
i
1
2
3
4
10
20
30
create table t3 like t1;
begin;
insert into t3 values (100), (200), (300);
commit;
alter table t1 add column j int;
alter table t2 add key uk(i);
drop table t1, t2;
optimize table t3;
Table	Op	Msg_type	Msg_text
test.t3	optimize	note	Table does not support optimize, doing recreate + analyze instead
test.t3	optimize	status	OK
analyze table t3;
Table	Op	Msg_type	Msg_text
test.t3	analyze	status	OK
alter table t3 add column k int;
begin;
insert into t3 values (1000, 1000), (2000, 2000);
commit;
select * from t3;
i	k
100	NULL
200	NULL
300	NULL
1000	1000
2000	2000
SHOW BINLOG EVENTS IN 'mysqld-bin.000001' FROM 125;
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
mysqld-bin.000001	125	Previous_gtids	1	156	
mysqld-bin.000001	156	Anonymous_Gtid	1	233	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	233	Query	1	377	use `test`; create table t1 (i int, primary key pk(i)) engine=innodb /* xid=### */
mysqld-bin.000001	377	Anonymous_Gtid	1	456	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	456	Query	1	536	BEGIN
mysqld-bin.000001	536	Table_map	1	584	table_id: ### (test.t1)
mysqld-bin.000001	584	Write_rows	1	639	table_id: ### flags: STMT_END_F
mysqld-bin.000001	639	Xid	1	670	COMMIT /* xid=### */
mysqld-bin.000001	670	Anonymous_Gtid	1	749	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	749	Query	1	824	BEGIN
mysqld-bin.000001	824	Query	1	954	use `test`; CREATE TABLE `t2` (
  `i` int NOT NULL
) START TRANSACTION
mysqld-bin.000001	954	Table_map	1	1002	table_id: ### (test.t2)
mysqld-bin.000001	1002	Write_rows	1	1057	table_id: ### flags: STMT_END_F
mysqld-bin.000001	1057	Xid	1	1088	COMMIT /* xid=### */
mysqld-bin.000001	1088	Anonymous_Gtid	1	1167	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1167	Query	1	1247	BEGIN
mysqld-bin.000001	1247	Table_map	1	1295	table_id: ### (test.t2)
mysqld-bin.000001	1295	Write_rows	1	1345	table_id: ### flags: STMT_END_F
mysqld-bin.000001	1345	Xid	1	1376	COMMIT /* xid=### */
mysqld-bin.000001	1376	Anonymous_Gtid	1	1453	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1453	Query	1	1557	use `test`; create table t3 like t1 /* xid=### */
mysqld-bin.000001	1557	Anonymous_Gtid	1	1636	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1636	Query	1	1716	BEGIN
mysqld-bin.000001	1716	Table_map	1	1764	table_id: ### (test.t3)
mysqld-bin.000001	1764	Write_rows	1	1814	table_id: ### flags: STMT_END_F
mysqld-bin.000001	1814	Xid	1	1845	COMMIT /* xid=### */
mysqld-bin.000001	1845	Anonymous_Gtid	1	1922	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1922	Query	1	2041	use `test`; alter table t1 add column j int /* xid=### */
mysqld-bin.000001	2041	Anonymous_Gtid	1	2118	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2118	Query	1	2234	use `test`; alter table t2 add key uk(i) /* xid=### */
mysqld-bin.000001	2234	Anonymous_Gtid	1	2311	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2311	Query	1	2443	use `test`; DROP TABLE `t1`,`t2` /* generated by server */ /* xid=### */
mysqld-bin.000001	2443	Anonymous_Gtid	1	2520	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2520	Query	1	2614	use `test`; optimize table t3
mysqld-bin.000001	2614	Anonymous_Gtid	1	2691	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2691	Query	1	2777	use `test`; analyze table t3
mysqld-bin.000001	2777	Anonymous_Gtid	1	2854	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2854	Query	1	2973	use `test`; alter table t3 add column k int /* xid=### */
mysqld-bin.000001	2973	Anonymous_Gtid	1	3052	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	3052	Query	1	3132	BEGIN
mysqld-bin.000001	3132	Table_map	1	3181	table_id: ### (test.t3)
mysqld-bin.000001	3181	Write_rows	1	3234	table_id: ### flags: STMT_END_F
mysqld-bin.000001	3234	Xid	1	3265	COMMIT /* xid=### */
#=============================================
#node-2 (check for replication followed by XID)
SHOW BINLOG EVENTS IN 'mysqld-bin.000001' FROM 125;
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
mysqld-bin.000001	125	Previous_gtids	2	156	
mysqld-bin.000001	156	Anonymous_Gtid	1	233	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	233	Query	1	377	use `test`; create table t1 (i int, primary key pk(i)) engine=innodb /* xid=### */
mysqld-bin.000001	377	Anonymous_Gtid	1	456	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	456	Query	1	531	BEGIN
mysqld-bin.000001	531	Table_map	1	579	table_id: ### (test.t1)
mysqld-bin.000001	579	Write_rows	1	634	table_id: ### flags: STMT_END_F
mysqld-bin.000001	634	Xid	1	665	COMMIT /* xid=### */
mysqld-bin.000001	665	Anonymous_Gtid	1	744	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	744	Query	1	819	BEGIN
mysqld-bin.000001	819	Query	1	949	use `test`; CREATE TABLE `t2` (
  `i` int NOT NULL
) START TRANSACTION
mysqld-bin.000001	949	Table_map	1	997	table_id: ### (test.t2)
mysqld-bin.000001	997	Write_rows	1	1052	table_id: ### flags: STMT_END_F
mysqld-bin.000001	1052	Xid	1	1083	COMMIT /* xid=### */
mysqld-bin.000001	1083	Anonymous_Gtid	1	1162	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1162	Query	1	1237	BEGIN
mysqld-bin.000001	1237	Table_map	1	1285	table_id: ### (test.t2)
mysqld-bin.000001	1285	Write_rows	1	1335	table_id: ### flags: STMT_END_F
mysqld-bin.000001	1335	Xid	1	1366	COMMIT /* xid=### */
mysqld-bin.000001	1366	Anonymous_Gtid	1	1443	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1443	Query	1	1547	use `test`; create table t3 like t1 /* xid=### */
mysqld-bin.000001	1547	Anonymous_Gtid	1	1626	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1626	Query	1	1701	BEGIN
mysqld-bin.000001	1701	Table_map	1	1749	table_id: ### (test.t3)
mysqld-bin.000001	1749	Write_rows	1	1799	table_id: ### flags: STMT_END_F
mysqld-bin.000001	1799	Xid	1	1830	COMMIT /* xid=### */
mysqld-bin.000001	1830	Anonymous_Gtid	1	1907	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	1907	Query	1	2026	use `test`; alter table t1 add column j int /* xid=### */
mysqld-bin.000001	2026	Anonymous_Gtid	1	2103	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2103	Query	1	2219	use `test`; alter table t2 add key uk(i) /* xid=### */
mysqld-bin.000001	2219	Anonymous_Gtid	1	2296	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2296	Query	1	2428	use `test`; DROP TABLE `t1`,`t2` /* generated by server */ /* xid=### */
mysqld-bin.000001	2428	Anonymous_Gtid	1	2505	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2505	Query	1	2599	use `test`; optimize table t3
mysqld-bin.000001	2599	Anonymous_Gtid	1	2676	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2676	Query	1	2762	use `test`; analyze table t3
mysqld-bin.000001	2762	Anonymous_Gtid	1	2839	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	2839	Query	1	2958	use `test`; alter table t3 add column k int /* xid=### */
mysqld-bin.000001	2958	Anonymous_Gtid	1	3037	SET @@SESSION.GTID_NEXT= 'ANONYMOUS'
mysqld-bin.000001	3037	Query	1	3112	BEGIN
mysqld-bin.000001	3112	Table_map	1	3161	table_id: ### (test.t3)
mysqld-bin.000001	3161	Write_rows	1	3214	table_id: ### flags: STMT_END_F
mysqld-bin.000001	3214	Xid	1	3245	COMMIT /* xid=### */
drop table t3;
